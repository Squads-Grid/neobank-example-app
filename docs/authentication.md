# Authentication Flow

The authentication process consists of two main steps: email verification and OTP verification. This document explains how to implement this flow in your application.

## Step 1: Email Verification

The email verification process is triggered in [`app/(auth)/login.tsx`](app/(auth)/login.tsx) when a user enters their email address. This step:

1. Calls the `v0/grid/smart-accounts/auth` endpoint with:
   - User's email
   - Optional: `app_name` and `app_icon_url` for branding
   - Optional: Credential expiration time

2. The Grid API:
   - Sends an OTP to the user's email
   - Returns an `mpcPrimaryId` (unique identifier for login/signup)
   - Returns an `otp_id` (needed for OTP verification)

3. Store these values securely:
   - In this demo, we use Expo SecureStore for simplicity
   - You might implement your own solution
   - The `mpcPrimaryId` can be stored permanently
   - The `otp_id` is temporary and only needed for verification

## Step 2: OTP Verification

When the user enters the OTP code:

1. Generate a new keypair using `generateKeyPairP256` from [`grid/authorization.ts`](grid/authorization.ts)
   - This keypair is for temporary use only
   - Do not store it permanently
   - Create a new keypair for each verification
   - Used to decrypt the credential bundle

2. Send to the `/verify` endpoint:
   - The OTP code
   - The `otp_id` from Step 1
   - The public key from the generated keypair
   - The `mpcPrimaryId` from Step 1

3. The Grid API returns a credential bundle that can be decrypted using the private key from the generated keypair

## Important Notes

- The keypair generated by `generateKeyPairP256` should:
  - Be created fresh for each verification
  - Not be stored permanently
  - Not be reused
- When credentials expire, generate a new keypair for the next verification
- The `mpcPrimaryId` is the only value that should be stored permanently
- All other values (`otp_id`, keypairs) are temporary and should be discarded after use

## Implementation Example

```typescript
// Step 1: Email Verification
const { mpcPrimaryId, otp_id } = await authenticate(email);

// Step 2: OTP Verification
const keypair = generateKeyPairP256();
const credentialBundle = await verifyCode(otp, otp_id, keypair.publicKey, mpcPrimaryId);
```

## Security Considerations

- Use secure storage for sensitive data
- Never store the private key from the keypair permanently
- Generate new keypairs for each verification
- Handle credential expiration gracefully
- Implement proper error handling for failed verifications
